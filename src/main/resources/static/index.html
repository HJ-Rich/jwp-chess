<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="shortcut icon" href="/img/favicon.png"/>
    <link rel="stylesheet" href="/css/button.css">
    <link rel="stylesheet" href="/css/roomCreatePopup.css">
    <link rel="stylesheet" href="/css/room.css">
    <title>체스</title>
</head>
<body>
<h1>Level 2, 웹 체스</h1>
<div>
    <button type="button" class="button-30" id="roomCreateButton">방 만들기</button>
</div>

<div id="roomCreatePopup" class="invisible">
    <h2>방 만들기</h2><br>
    <input id="roomNameInput" type="text" placeholder="방 제목"/><br>
    <input id="roomPasswordInput" type="password" placeholder="비밀번호"/><br>
    <input id="whiteNameInput" type="text" placeholder="흰색 닉네임"/><br>
    <input id="blackNameInput" type="text" placeholder="검정색 닉네임"/><br>
    <button id="sendRoomCreateRequestButton" class="button-30" type="button">방 만들기</button>
    <button id="closeRoomCreatePopupButton" class="button-30" type="button">취소</button>
</div>

<div id="roomContainer">
</div>

<script>
    const roomCreateUrl = `/board`;
    const gamesUrl = `/games`;


    const roomContainer = document.getElementById('roomContainer');
    const roomCreatePopup = document.getElementById('roomCreatePopup');
    const roomCreateButton = document.getElementById('roomCreateButton');
    const roomNameInput = document.getElementById('roomNameInput');
    const roomPasswordInput = document.getElementById('roomPasswordInput');
    const whiteNameInput = document.getElementById('whiteNameInput');
    const blackNameInput = document.getElementById('blackNameInput');

    const closeRoomCreatePopup = () => {
        roomCreatePopup.classList.toggle('invisible');
    }

    roomCreateButton.addEventListener('click', (e) => {
        roomCreatePopup.classList.toggle('invisible');
    })

    document.getElementById('closeRoomCreatePopupButton').addEventListener('click', closeRoomCreatePopup);

    document.getElementById('sendRoomCreateRequestButton').addEventListener('click', (e) => {
        if (roomNameInput.value.length === ''
            || roomPasswordInput.value === ''
            || whiteNameInput.value === ''
            || blackNameInput.value === '') {
            return;
        }

        fetch(roomCreateUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json;charset=utf-8'
            },
            body: JSON.stringify({
                roomName: roomNameInput.value,
                roomPassword: roomPasswordInput.value,
                whiteName: whiteNameInput.value,
                blackName: blackNameInput.value
            })
        }).then(res => res.json())
            .then(json => location.href = `/game/${json.id}`);
    });


    fetch(gamesUrl)
        .then(res => res.json())
        .then(json => {
            console.log(json);
            json.forEach(e => roomContainer.appendChild(createRoomElement(e)));
        });

    const deleteRoom = (event) => {
        fetch(`${gamesUrl}/${event.target.dataset.id}`, {
            'method': 'delete',
            'content-type': 'application/json; charset=utf-8'
        }).then(res => location.reload());
    }

    const createRoomElement = (gameRoomDto) => {
        const gameEnterUrl = `/game/${gameRoomDto.id}`;
        return new DOMParser()
            .parseFromString(
                `<div class="room">
                    <button class="button-30 deleteRoomButton" onclick="deleteRoom(event)" data-id="${gameRoomDto.id}">X</button>
                    <span>No. ${gameRoomDto.id} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                    <span>${gameRoomDto.whiteName} vs ${gameRoomDto.blackName}</span>
                    <h3>
                        <a href=${gameEnterUrl}> ${gameRoomDto.roomName}</a>
                    </h3>
                </div>`
                , "text/html")
            .body
            .firstElementChild;
    }
</script>
</body>
</html>
